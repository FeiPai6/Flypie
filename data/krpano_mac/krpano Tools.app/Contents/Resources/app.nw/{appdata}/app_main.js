function nwrequire(e){return require(e)}function main(){var e=require("nw.gui"),t=e.Window.get();top.addEventListener("beforeunload",main_before_close_app,!0),t.on("close",main_close_app),ksystem.runDetection(),gui_style_do_system_fixes();var n=JSON.parse(localStorage.gui_settings||"null");n?(ksystem.setZoomFactor(n.zoom),gui_modal_rendermode=n.rendermode|0,gui_settings_bg_blur=!!n.blur,gui_settings_fading=!!n.fade):ksystem.setZoomFactor(1),gui_window_state.load(),setTimeout(function(){var e=document.getElementById("mainframe");e.style.width="99.9999%",e.offsetHeight,e.style.width="100%"},100),gui_window_state.show(),gui_block_external_dragging(),gui_contextmenu_setup(),parse_cmdline_args(),krpanotools.connect(callback_krpanotools_ready),krpanoviewer.loadViewerFiles()}function parse_cmdline_args(){var e=require("nw.gui"),t=e.App.argv,n,r;r=t?t.length|0:0;for(n=0;n<r;n++){var i=(""+t[n]).toLowerCase();i=="-debug"?debug_contextmenu():i.substr(0,7)=="-umode:"&&(krpanotools.umode=i.slice(7))}}function show_dev_tools(){function n(e,n){t==null&&(t=[0,0,0,0]),t[2]=e,t[3]=n}function r(e,n){t==null&&(t=[0,0,0,0]),t[0]=e,t[1]=n}var e=require("nw.gui").Window.get().showDevTools(),t=null;t=JSON.parse(localStorage.debugWindowState||"null"),e.on("resize",n),e.on("move",r),gui_get_global().shutdownEvents.push(function(){e.removeListener("resize",n),e.removeListener("move",r),localStorage.debugWindowState=JSON.stringify(t)}),t&&(t[0]!=0&&t[1]!=0&&e.moveTo(t[0],t[1]),t[2]>0&&t[3]>0&&e.resizeTo(t[2],t[3]))}function main_closing_exceptions(e){alert("shutdown exception: "+e),this.close(!0)}function main_before_close_app(){var e=require("nw.gui"),t=e.Window.get();t.removeListener("close",main_close_app);var n=gui_reset?!1:!0;n&&gui_window_state.save(),process.on("uncaughtException",main_closing_exceptions);var r=gui_get_global(),i=r.shutdownEvents;if(i.length>0){var s;try{for(s=0;s<i.length;s++)i[s]!=null&&i[s](n)}catch(o){alert("shutdown error: "+o)}}n&&(localStorage.gui_settings=JSON.stringify({zoom:ksystem.getZoomFactor(),rendermode:gui_modal_rendermode,blur:gui_settings_bg_blur,fade:gui_settings_fading})),r.reset(),krpanotools&&(krpanotools.exit(),krpanotools=null),process.removeListener("uncaughtException",main_closing_exceptions)}function main_close_app(){main_before_close_app(),this.close(!0)}function callback_krpanotools_ready(){krpanotools.getRegInfo(function(e){app_update_reginfo(e);var t=0;e&&(regmap=helper_tags_to_map(e),regmap.lz&&(t=parseInt(regmap.lz))),(t&1)==0&&gui_modal_window("frames/intro_notregistered.html")})}function helper_tags_to_map(e){var t={},n=e.split(";"),r;for(r=0;r<n.length;r++){var i=n[r].split("=");i.length==2&&(t[i[0]]=i[1])}return t}function app_update_reginfo(e){var t={},n=0;e&&(t=helper_tags_to_map(e),t.lz&&(n=parseInt(t.lz))),app_update_external_viewer_licenses(t),app_update_license_info(n,t)}function app_update_license_info(e,t){reginfo.ready=!0,reginfo.lz=e,reginfo.tags=t;var n=document.getElementById("tab_protect").contentWindow;n&&n.update_license_info&&n.update_license_info(e,t)}function app_update_external_viewer_licenses(e){var t=require("path"),n=require("fs"),r=krpanotools.get_krpanotools_basepath(),i=r+"viewer"+t.sep,s=i+"krpano.swf",o=i+"krpano.js";n.exists(s,function(t){t&&krpanotools.loadRegInfo(s,function(t){var n=helper_tags_to_map(t),r=n.id?n.id:"",i=e.orderid&&e.orddate?e.orderid+"/"+e.orddate:"",o=n.rg?n.rg:"",u=e.regname?e.regname:"",a=n.ma?n.ma:"",f=e.regmail?e.regmail:"",l=r==i&&o==u&&a==f;if(l==0){var c=[];c.push(krpanotools.encodeParam("-o="+s)),c.push("-bf"),krpanotools.protectTool(c.join(" "),function(e){})}})}),n.exists(o,function(t){t&&krpanotools.loadRegInfo(o,function(t){var n=helper_tags_to_map(t),r=n.id?n.id:"",i=e.orderid&&e.orddate?e.orderid+"/"+e.orddate:"",s=n.rg?n.rg:"",u=e.regname?e.regname:"",a=n.ma?n.ma:"",f=e.regmail?e.regmail:"",l=r==i&&s==u&&a==f;if(l==0){var c=[];c.push(krpanotools.encodeParam("-o="+o)),c.push("-nojsmerge"),c.push("-bf"),krpanotools.protectTool(c.join(" "),function(e){})}})})}function fatalerror(e){gui_modal_window("frames/fatalerror.html",{fs:!0,esckey:!1,blur:!0,args:[e]},!0)}var reginfo={ready:!1,tags:null,lz:0},gui_reset=!1