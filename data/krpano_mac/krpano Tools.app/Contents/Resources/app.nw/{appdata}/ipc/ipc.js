function ipc_connect(e,t,n){function u(e){console.log("ipc_connect - uncaughtException - loadingerror - "+e),n(e)}function a(){o&&(o.kill(),toll=null)}function v(e){if(e.slice(0,4)=="ret:"){var t=e.indexOf(":",4)+1,n=e.indexOf(":",t)+1,r=e.slice(4,t-1),i=e.slice(t,n-1);e=e.slice(n);var s=y.length,o,u=null;for(o=0;o<s;o++){u=y[o];if(u.id==r)break}return u!=null&&(i=="start"&&u.start!=null?u.start(e,u):i=="progress"&&u.progress!=null?(e&&console.log("cmd["+u.id+"/"+i+"]=["+e+"]"),u.progress(e,u)):i=="error"?(e&&console.log("cmd["+u.id+"/"+i+"]=["+e+"]"),y.splice(o,1),u.error!=null?u.error(e,u):console.log("cmd["+u.msg+"] - missed error: "+e)):i=="done"&&(y.splice(o,1),u.done!=null&&u.done(e,u))),!0}return!1}function m(e){if(o==null)return;var t=Buffer.byteLength(e),n=new Buffer(4+t);n.writeInt32LE(t,0),n.write(e,4);var r=o.stdin.write(n)}function b(e,t,n,r,i,s){this.id=e,this.msg=t,this.start=n,this.done=r,this.progress=i,this.error=s}var r=require("path"),i=require("child_process").spawn,s=this;s.running=!1;var o=null,f=!0;process.on("uncaughtException",u),process.on("exit",a),o=i(e,["ipc"],{stdio:["pipe","pipe","pipe"],detached:!1}),o.on("error",function(t){f&&(f=!1,process.removeListener("uncaughtException",u)),s.running=!1,o=null,n("Running process '"+e+"' failed!")}),s.pid=o.pid;var l=0,c=null,h=null,p=0,d=0;o.stdout.on("data",function(i){if(o==null)return;if(f){if(!(i.length>=4&&i.slice(0,4)=="KIPC")){n("Establishing IPC connection to '"+r.basename(e)+"' failed!");return}i=i.slice(4),f=!1,process.removeListener("uncaughtException",u),s.running=!0,t(s)}l+=i.length;var a=i.length,m=0;c!=null&&(i=Buffer.concat([c,i]),a=i.length,c=null);if(h!=null)if(a<=d){i.copy(h,p,m,m+a),p+=a,d-=a,m+=a,a=0;if(d==0){var g=h.toString("utf8",0,p);v(g)==0&&console.log("ipc - unknown data: "+g),h=null}else d<0&&console.log("incompletedata - error1")}else{i.copy(h,p,m,m+d),p+=d,m+=d,a-=d,d=0;var g=h.toString("utf8",0,p);v(g)==0&&console.log("ipc - unknown data: "+g),h=null}if(a>0){var y="";for(;;){if(!(a>=4)){if(a>0){c=new Buffer(a),i.copy(c,0,m,m+a);break}break}var b=i.readUInt32LE(m);m+=4,a-=4;if(!(a>0&&b>0&&b<=a)){b>0&&(h=new Buffer(b),p=0,d=b,a>0&&(i.copy(h,p,m,m+a),p+=a,d-=a,m+=a));break}var g=i.toString("utf8",m,m+b);a-=b,m+=b,v(g)==0&&console.log("ipc - unknown data: "+g);if(a==0)break}}}),o.stderr.on("data",function(e){console&&console.log&&console.log("err-data:"+e)}),o.on("close",function(e,t){s.running&&(s.running=!1,console&&console.log&&console.log("child process closed stdio streams - signal="+t+" code="+e))}),o.on("exit",function(t,n){s.running&&(s.running=!1,o=null,console&&console.log&&(console.log("child process terminated due to receipt of signal "+n+" (code="+t+")"),setTimeout(function(){fatalerror("The "+r.basename(e)+" process crashed...")},500)))}),s.tool=o;var g=0,y=[];s.sendCommandSync=function(e,t,n,r){var i=g++,s=new b(i,e,null,t,n,r);y.push(s),m("cmds:"+i+":"+e)},s.sendCommand=function(e,t,n,r,i){var s=g++,o=new b(s,e,t,n,r,i);y.push(o),m("cmda:"+s+":"+e)},s.getCommandStats=function(){return"total:"+g+" pending:"+y.length},s.exit=function(){m("exit"),s.tool=o=null,process.removeListener("exit",a)}}