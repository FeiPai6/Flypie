<!DOCTYPE html><head><title>Update</title><link rel="stylesheet" href="../design/style.css"><link rel="stylesheet" href="../design/gui_listbox.css"><style>html{height:100%}body{height:100%;margin:0;padding:0}</style></head><body><div id="updateframe" style="position:absolute;width:100%;height:100%;display:table" onselectstart="return false"><div style="display:table-row; xbackground-color:#FFFF77"><div style="color:#336699;margin:10px"><b>Update</b> - Update krpano Flash (.swf) and HTML5 (.js) viewer files. When updating, the core krpano viewers and the krpano embedding-scripts will be replaced by their new versions. Embedded data inside the viewer files, like the license information, the protection settings or embedded files will be left unchanged. Plugin files will be directly replaced by their new version.</div></div><div style="display:table-row;height:100%; xbackground-color:#77FFFF"><table style="font-size:inherit;height:100%;padding:0;margin:0 10px" cellspacing="0"><tr style="height:100%"><td style="width:100%;margin:0;padding:0;vertical-align:top"><div id="m_updfiles" style="padding:0; margin:0; width:100%; height:100%;position:relative"></div></td><td></td><td style="margin:0;padding:0;vertical-align:top;padding:0;padding-left:4px"><table style="margin:0;padding:0" cellspacing="0"><tr><td style="margin:0;padding:0"><input style="margin-top:0;width:100%" type="button" value="Add Files" onclick="on_add_files()"><br><input style="width:100%" type="button" value="Add Folder" onclick="on_add_folder()"><br><input style="width:100%" type="button" value="Remove" onclick="on_remove()"><br><input style="width:100%" type="button" value="Remove All" onclick="on_remove_all()"><br></td></tr></table></td></tr></table></div><div style="display:table-row; xbackground-color:#FFFF77"><div style="margin:4px 0 10px 10px"><input style="vertical-align:middle" id="m_ubkp" type="checkbox" checked="checked" onclick="on_check_backup()"><label style="<span style=" vertical-align:middle="" for="m_ubkp">Backup&nbsp;original&nbsp;files</label></div></div><div style="display:table-row; xbackground-color:green"><div style="margin:4px 0 10px 10px"><input type="button" value="Update Files" onclick="on_updatefiles()"><br></div></div></div></body><script>function updatefile(){this.order=0,this.filepath=null,this.type=null,this.version=null,this.size=0,this.skip=!1}function ID(e){return document.getElementById(e)}function savesettings(){localStorage&&(localStorage.updatetool=JSON.stringify(settings))}function loadsettings(){var e=JSON.parse(localStorage.updatetool||"null");settings.opt_backup=e?e.opt_backup:!0,settings.ui_last_add_folder=e?e.ui_last_add_folder:null,ID("m_ubkp").checked=settings.opt_backup}function on_check_backup(){var e=ID("m_ubkp").checked;settings.opt_backup=e}function format_filesize(e){return e<1024?e+" Byte":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB"}function dateToYMDT(e,t,n,r){var i=e.getDate(),s=e.getMonth()+1,o=e.getFullYear(),u=e.getHours(),a=e.getMinutes(),f=e.getSeconds();return""+o+t+(s<=9?"0"+s:s)+t+(i<=9?"0"+i:i)+n+(u<=9?"0"+u:u)+r+(a<=9?"0"+a:a)+r+(f<=9?"0"+f:f)}function data_sort_compare(e,t){return e.skip&&!t.skip?1:!e.skip&&t.skip?-1:e.filepath<t.filepath?-1:e.filepath>t.filepath?1:0}function data_sort_filelist(){m_updatefiles.sort(data_sort_compare)}function data_update_filelist_gui(){if(m_updfiles_listbox&&m_updatefiles){var e=m_updatefiles,t,n=e.length;m_updfiles_listbox.removeAll();for(t=0;t<n;t++){var r=e[t],i=r.type,s=r.version,o=r.skip;o?m_updfiles_listbox.addTextRow([r.filepath,s],{color:"gray"},[1,3]):m_updfiles_listbox.addTextRow([r.filepath,i,s,format_filesize(r.size)])}m_updfiles_listbox.selectedIndex=-1}}function on_add_files(){var e=settings.ui_last_add_folder;top.gui_dialogs.openFile(add_files_callback,e,!0,".swf,.js")}function on_add_folder(){var e=settings.ui_last_add_folder;top.gui_dialogs.openDir(add_folder_callback,e)}function on_remove(){var e,t=m_updfiles_listbox.options,n=m_updatefiles;for(e=t.length-1;e>=0;e--)t[e].selected&&(m_updfiles_listbox.removeRow(e),n.splice(e,1))}function on_remove_all(){m_updatefiles=[],data_update_filelist_gui()}function print_type(e){switch(e){case"SWF":return"Flash Viewer";case"H5":return"HTML5 Viewer";case"ES":return"Embedding Script";case"H5+ES":return"Embedding+HTML5"}return"Unknown"}function data_add_file(e,t){var n=m_updatefiles,r=n.length,i,s=path.basename(e),o=path.extname(s).toLowerCase();if(o!=".swf"&&o!=".js")return;if(s=="krpanoiphone.license.js")return;for(i=0;i<r;i++)if(n[i].filepath==e)return;var u=top.krpanoviewer.getPluginFilepath(s.toLowerCase());if(u){var a=new updatefile;a.order=n.length,a.filepath=e,a.size=t,a.type="Plugin",a.version="",a.plugin=u,n.push(a)}else top.krpanotools.updateCheck(top.krpanotools.encodeParam(e),function(r){var i=top.helper_tags_to_map(r),s=r.indexOf("ERROR:")==0;if(r==""||s||i["canupdate"]!="true"){var o=new updatefile;o.order=n.length,o.filepath=e,o.size=t,o.type=i.type,o.skip=!0,o.version=s?r+"!":i.info?""+i.info+"!":"Unknown file!",n.push(o)}else{var o=new updatefile;o.order=n.length,o.filepath=e,o.size=t,o.type=print_type(i.type),o.version=i.version?i.version.split(" ")[0]:"Unknown",n.push(o)}data_sort_filelist(),data_update_filelist_gui()})}function add_files_callback(e,t,n){if(t){var r,i=t.length;i>0&&(settings.ui_last_add_folder=path.dirname(t[0].path)+path.sep);for(r=0;r<i;r++){var s=t[r];data_add_file(s.path,s.size)}data_sort_filelist(),data_update_filelist_gui()}}function add_folder_callback(e,t){var n=t.length,r;n>0&&(settings.ui_last_add_folder=t[0].path+path.sep);for(r=0;r<n;r++){var i=t[r],s=fs.statSync(i.path);s&&(s.isDirectory()?top.ksystem.walkDirASync(i.path,function(e,t){if(!e&&m_updfiles_listbox&&m_updatefiles){var n=t.length,r;for(r=0;r<n;r++)data_add_file(t[r].path,t[r].size);data_sort_filelist(),data_update_filelist_gui()}}):data_add_file(i.path,i.size))}data_sort_filelist(),data_update_filelist_gui()}function on_updatefiles(){if(m_updatefiles.length<=0){top.krpanoui.alertDialog({title:"Update Files",infotext:"No files to update..."});return}top.krpanoui.progressDialog({title:"Update Files",infotext:"Updating files...",buttonmode:0,height:200,locked:!0,onready:function(e){e.setFocusButton(0),e.setProgress(0,1),on_updatefiles_process(e)},onclose:null})}function on_updatefiles_process(e){function a(t,n,r){t.indexOf("ERROR")==0?u++:o++;var i="Updated "+o+" of "+s+" files.";u>0&&(i+=" <span style='color:red;'>Error: "+u+" files failed!</span>");var a=o+u;a==s&&(i+=" Done.",on_remove_all(),e.setLocked(!1)),e.setInfotext(i),e.setProgress(a,s)}function f(e){return function(t,n){a(t,n,e)}}function l(e,t,n){fs.readFile(e,null,function(e,r){e?a("ERROR: Copy file failed",null,n):fs.writeFile(t,r,{encoding:null},function(e){e?a("ERROR: Copy file failed",null,n):a("OKAY",null,n)})})}var t=m_updatefiles.length,n,r=settings.opt_backup,i=new Date,s=0,o=0,u=0;for(n=0;n<t;n++){var c=[],h=m_updatefiles[n];if(h.skip)continue;var p=h.filepath,d=p;h.processing=!0;if(r){var v=p+".backup-"+dateToYMDT(i,"-","-","-");try{fs.renameSync(p,v),p=v}catch(m){s++,a("ERROR: Backup failed",null,h);continue}}h.type=="Plugin"&&h.plugin?(s++,l(h.plugin,d,h)):(s++,top.krpanotools.updateFile(top.krpanotools.encodeParam(p)+" "+top.krpanotools.encodeParam(d),f(h)))}s==0&&(e.setLocked(!1),e.setInfotext("Done."),e.setProgress(1,1))}var path=top.require("path"),fs=top.require("fs"),settings={opt_backup:!0,ui_last_add_folder:null},pluginfiles=null,m_updatefiles=[];top.gui_style_do_system_fixes(document),top.gui_block_external_dragging(document);var m_updfiles_listbox=top.gui_listbox(ID("m_updfiles"),[{name:"Filename",width:"500%",minwidth:100,align:"left"},{name:"Type",width:120,minwidth:50,align:"left"},{name:"Version",width:50,minwidth:50,align:"left"},{name:"Filesize",width:80,minwidth:50,align:"right"}],{enableFileDropping:!0});top.gui_get_global().shutdownEvents.push(function(e){e&&savesettings()}),loadsettings(),m_updfiles_listbox.onDroppedFiles=function(e){add_folder_callback(null,e)},m_updfiles_listbox.onContextMenu=function(e,t){var n=m_updfiles_listbox.options,r=m_updatefiles,i,s=r.length,o=0;for(i=0;i<s;i++)n[i].selected&&o++;if(o>0){var u=top.gui_contextmenu_create();u.addItem({type:"normal",label:"Remove file"+(o==1?"":"s"),click:function(){on_remove()}}),u.popup(t)}}</script>