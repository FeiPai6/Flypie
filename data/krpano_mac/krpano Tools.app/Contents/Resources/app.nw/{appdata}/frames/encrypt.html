<!DOCTYPE html><head><title>krpano Tools</title><link rel="stylesheet" href="../design/style.css"><link rel="stylesheet" href="../design/gui_listbox.css"><style>html{height:100%}body{height:100%;margin:0;padding:0}</style></head><body><div id="encryptframe" style="position:absolute;width:100%;height:100%;display:table" onselectstart="return false"><div style="display:table-row;xbackground-color:#FF33FF"><div style="color:#336699;margin:10px"><b>Encrypt</b> - Files that will be loaded directly by krpano viewer can be encrypted and compressed. The krpano viewer will decrypt and decompress them during loading.</div></div><div style="display:table-row;height:100%; xbackground-color:#77FFFF"><table style="font-size:inherit;height:100%;padding:0;margin:0 10px" cellspacing="0"><tr style="height:100%"><td style="width:100%;margin:0;padding:0;vertical-align:top"><div id="m_encfiles" style="padding:0; margin:0; width:100%; height:100%;position:relative"></div></td><td></td><td style="margin:0;padding:0;vertical-align:top;padding:0;padding-left:4px"><table style="margin:0;padding:0" cellspacing="0"><tr><td style="margin:0;padding:0"><input style="margin-top:0;width:100%" type="button" value="Add Files" onclick="on_add_files()"><br><input style="width:100%" type="button" value="Add Folder" onclick="on_add_folder()"><br><input style="width:100%" type="button" value="Remove" onclick="on_remove()"><br><input style="width:100%" type="button" value="Remove All" onclick="on_remove_all()"><br></td></tr></table></td></tr></table></div><div style="display:table-row; xbackground-color:#FFFF77"><div style="margin:4px 0 10px 10px"><span style="white-space:nowrap"><input id="m_encp" type="checkbox" checked="checked" onclick="on_check_privateenc()"><label for="m_encp">Use private encryption</label></span><br><span style="white-space:nowrap"><input id="m_encz" type="checkbox" checked="checked" onclick="on_check_compress()"><label for="m_encz">Compress encrypted files (xml and js files only)</label></span><br><span style="white-space:nowrap"><input id="m_ebup" type="checkbox" checked="checked" onclick="on_check_backup()"><label for="m_ebup">Backup original files</label></span><br><span style="white-space:nowrap"><input id="m_ebin" type="checkbox" onclick="on_check_flashenc()"><label for="m_ebin">Encrypt also image files (Warning: Flash-only!)</label></span><br></div></div><div style="display:table-row; xbackground-color:green"><div style="margin:4px 0 10px 10px"><input type="button" value="Encrypt Files" onclick="on_encryptfiles()"><br></div></div></div></body><script>function encryptedfile(){this.filepath=null,this.type=null,this.size=0,this.skip=!1}function ID(e){return document.getElementById(e)}function savesettings(){localStorage&&(localStorage.encrypt=JSON.stringify(settings))}function loadsettings(){var e=JSON.parse(localStorage.encrypt||"null");settings.opt_private=e?e.opt_private:!0,settings.opt_compress=e?e.opt_compress:!0,settings.opt_backup=e?e.opt_backup:!0,settings.opt_flashenc=e?e.opt_flashenc:!1,settings.ui_last_add_folder=e?e.ui_last_add_folder:null,ID("m_encp").checked=settings.opt_private,ID("m_encz").checked=settings.opt_compress,ID("m_ebup").checked=settings.opt_backup,ID("m_ebin").checked=settings.opt_flashenc}function data_add_file(e,t){var n=m_encryptedfiles,r=n.length,i;for(i=0;i<r;i++)if(n[i].filepath==e)return;var s=new encryptedfile;s.filepath=e,s.size=t;var o=path.basename(e),u=path.extname(o).toLowerCase(),a="Unsupported";switch(u){case".xml":a="XML";break;case".swf":a="Flash";break;case".js":a="JS";break;case".png":case".gif":case".jpg":case".jpeg":a="Image"}switch(o.toLowerCase()){case"tour.swf":case"tour.js":case"krpano.swf":case"krpano.js":case"embedpano.js":case"swfkrpano.js":case"swfobject.js":a="Viewer"}s.type=a,n.push(s)}function add_folder_callback(e,t){var n=t.length,r;n>0&&(settings.ui_last_add_folder=t[0].path+path.sep);for(r=0;r<n;r++){var i=t[r],s=fs.statSync(i.path);s&&(s.isDirectory()?top.ksystem.walkDirASync(i.path,function(e,t){if(!e&&m_encfiles_listbox&&m_encryptedfiles){var n=t.length,r;for(r=0;r<n;r++)t[r]&&t[r].path&&data_add_file(t[r].path,t[r].size);data_sort_filelist(),data_update_filelist_gui()}}):data_add_file(i.path,i.size))}data_sort_filelist(),data_update_filelist_gui()}function format_filesize(e){return e<1024?e+" Byte":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB"}function data_sort_compare(e,t){var n=type_sorting_map.indexOf(e.type),r=type_sorting_map.indexOf(t.type),i=e.filepath.toLowerCase(),s=t.filepath.toLowerCase();return n<r?1:n>r?-1:i<s?-1:i>s?1:0}function data_sort_filelist(){m_encryptedfiles.sort(data_sort_compare)}function data_update_filelist_gui(){if(m_encfiles_listbox&&m_encryptedfiles){var e=m_encryptedfiles,t,n=e.length;m_encfiles_listbox.removeAll();var r=settings.opt_flashenc;for(t=0;t<n;t++){var i=e[t],s=i.type,o=s=="XML"||s=="Flash"||s=="JS"||s=="Image"&&r;i.skip=!o,m_encfiles_listbox.addTextRow([i.filepath,s,format_filesize(i.size)],o?null:{color:"gray"})}m_encfiles_listbox.selectedIndex=-1}}function on_add_files(){var e=settings.ui_last_add_folder;top.gui_dialogs.openFile(add_files_callback,e,!0,".swf,.js,.xml,.png,.gif,.jpg,.jpeg")}function on_add_folder(){var e=settings.ui_last_add_folder;top.gui_dialogs.openDir(add_folder_callback,e)}function on_remove(){var e,t=m_encfiles_listbox.options,n=m_encryptedfiles;for(e=t.length-1;e>=0;e--)t[e].selected&&(m_encfiles_listbox.removeRow(e),n.splice(e,1))}function on_remove_all(){m_encryptedfiles=[],data_update_filelist_gui()}function add_files_callback(e,t,n){if(t){var r,i=t.length;i>0&&(settings.ui_last_add_folder=path.dirname(t[0].path)+path.sep);for(r=0;r<i;r++){var s=t[r];data_add_file(s.path,s.size)}data_sort_filelist(),data_update_filelist_gui()}}function on_check_privateenc(){var e=ID("m_encp").checked;settings.opt_private=e}function on_check_compress(){var e=ID("m_encz").checked;settings.opt_compress=e}function on_check_backup(){var e=ID("m_ebup").checked;settings.opt_backup=e}function on_check_flashenc(){var e=ID("m_ebin").checked;settings.opt_flashenc=e,data_update_filelist_gui()}function dateToYMDT(e,t,n,r){var i=e.getDate(),s=e.getMonth()+1,o=e.getFullYear(),u=e.getHours(),a=e.getMinutes(),f=e.getSeconds();return""+o+t+(s<=9?"0"+s:s)+t+(i<=9?"0"+i:i)+n+(u<=9?"0"+u:u)+r+(a<=9?"0"+a:a)+r+(f<=9?"0"+f:f)}function on_encryptfiles(){if(m_encryptedfiles.length<=0){top.krpanoui.alertDialog({title:"Encrypt Files",infotext:"No files to encrypt..."});return}top.krpanoui.progressDialog({title:"Encrypt Files",infotext:"Encrypting files...",buttonmode:0,height:200,locked:!0,onready:function(e){e.setFocusButton(0),e.setProgress(0,1),on_encryptfiles_process(e)},onclose:null})}function on_encryptfiles_process(e){function c(t,n,r){t.indexOf("ERROR")==0?l++:f++;var i="Encrypted "+f+" of "+a+" files.";l>0&&(i+=" <span style='color:red;'>Error: "+l+" files failed!</span>");var s=f+l;s==a&&(i+=" Done.",on_remove_all(),e.setLocked(!1)),e.setInfotext(i),e.setProgress(s,a)}function h(e){return function(t,n){c(t,n,e)}}var t=m_encryptedfiles.length,n,r=settings.opt_private,i=settings.opt_compress,s=settings.opt_backup,o=settings.opt_flashenc,u=new Date,a=0,f=0,l=0;for(n=0;n<t;n++){var p=[],d=m_encryptedfiles[n];if(d.skip)continue;d.processing=!0;var v=d.filepath;r==0&&p.push("-p"),i==1&&p.push("-z"),o==0&&p.push("-h5");if(s){var m=v+".backup-"+dateToYMDT(u,"-","-","-");p.push(top.krpanotools.encodeParam("-bk="+m))}p.push(top.krpanotools.encodeParam("-in="+v)),p.push(top.krpanotools.encodeParam("-out="+v)),a++,top.krpanotools.encryptFile(p.join(" "),h(d))}}var path=top.require("path"),fs=top.require("fs"),settings={opt_private:!0,opt_compress:!0,opt_backup:!0,opt_flashenc:!1,ui_last_add_folder:null},m_encryptedfiles=[];top.gui_style_do_system_fixes(document),top.gui_block_external_dragging(document);var m_encfiles_listbox=top.gui_listbox(ID("m_encfiles"),[{name:"Filename",width:"300%",minwidth:100,align:"left"},{name:"Type",width:100,minwidth:50,align:"left"},{name:"Filesize",width:100,minwidth:50,align:"right"}],{enableFileDropping:!0});top.gui_get_global().shutdownEvents.push(function(e){e&&savesettings()}),loadsettings();var type_sorting_map="Viewer.Image.Flash.JS.XML";m_encfiles_listbox.onDroppedFiles=function(e){add_folder_callback(null,e)},m_encfiles_listbox.onContextMenu=function(e,t){var n=m_encfiles_listbox.options,r=m_encryptedfiles,i,s=r.length,o=0;for(i=0;i<s;i++)n[i].selected&&o++;if(o>0){var u=top.gui_contextmenu_create();u.addItem({type:"normal",label:"Remove file"+(o==1?"":"s"),click:function(){on_remove()}}),u.popup(t)}}</script>